<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Cloud Native Infrastructure: Part 2 Monitoring - Luthadel</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Cloud Native Infrastructure: Part 2 Monitoring" />
<meta property="og:description" content="Monitoring." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://rudeigerc.github.io/posts/cloud_native_infrastructure_monitoring/" />
<meta property="article:published_time" content="2019-05-27T22:44:05&#43;08:00"/>
<meta property="article:modified_time" content="2019-05-28T01:03:50&#43;08:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cloud Native Infrastructure: Part 2 Monitoring"/>
<meta name="twitter:description" content="Monitoring."/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:500,100,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" /><script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script><script src="/js/main.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title">Luthadel</h1>
	<div class="site-description"><h2>Yuchen Cheng&rsquo;s Blog</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/rudeigerc" title="GitHub"><i data-feather="github"></i></a><a href="https://www.facebook.com/rudeigercheng" title="Facebook"><i data-feather="facebook"></i></a><a href="https://www.linkedin.com/in/rudeigerc/" title="LinkedIn"><i data-feather="linkedin"></i></a><a href="mailto:rudeigerc@gmail.com" title="Email"><i data-feather="mail"></i></a><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Cloud Native Infrastructure: Part 2 Monitoring</h1>
			<div class="meta">Posted at &mdash; May 27, 2019</div>
		</div>

		<div class="markdown">
			

<h2 id="introduction">Introduction</h2>

<h2 id="prometheus">Prometheus</h2>

<p><a href="https://prometheus.io/">Prometheus</a> is an open-source systems monitoring and alerting toolkit.</p>

<h3 id="installation">Installation</h3>

<p>In <code>docker-compose.yml</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">services:
  prometheus:
    image: prom/prometheus
    restart: always
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./prometheus:/prometheus
    ports:
      - 9090:9090
    user: root</code></pre></div>
<p>Prometheus provides a UI at <code>:9090</code> by default.</p>

<h3 id="node-exporter">Node Exporter</h3>

<p><a href="https://github.com/prometheus/node_exporter"><strong>Node Exporter</strong></a> is designed ad a Prometheus exporter for hardware and OS metrics exposed by *NIX kernels.</p>

<p>According to the documentation, it&rsquo;s not recommended to deploy it as a Docker container because it requires access to the host system, so you could just download the binary release version.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ wget https://github.com/prometheus/node_exporter/releases/download/v0.18.0/node_exporter-0.18.0.linux-amd64.tar.gz
$ tar -xvf node_exporter-0.18.0.linux-amd64.tar.gz
$ cd node_exporter-0.18.0.linux-amd64
<span style="color:#008000"># It&#39;s recommended to run the following instruction in tmux in order to keep it running after exit.</span>
$ ./node_exporter &amp;</code></pre></div>
<p>After started, <code>node_exporter</code> will be listening at <code>:9100</code>.</p>

<h3 id="service-registry">Service Registry</h3>

<p>In order to combine service <code>node-exporter</code> with <strong>Consul</strong>, a config directory should be configured.</p>

<p>In <code>consul.d/node_exporter.json</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  &#34;service&#34;: {
    &#34;name&#34;: <span style="color:#a31515">&#34;node_exporter&#34;</span>,
    &#34;tags&#34;: [<span style="color:#a31515">&#34;exporter&#34;</span>],
    &#34;address&#34;: <span style="color:#a31515">&#34;$PRIVATE_IP_ADDRESS&#34;</span>,
    &#34;port&#34;: 9100
  }
}</code></pre></div>
<p>In <code>docker-compose.yml</code> of Consul:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">version: <span style="color:#a31515">&#34;3&#34;</span>
services:
  consul:
    image: consul
    container_name: consul
    ports:
      - <span style="color:#a31515">&#34;8300:8300&#34;</span>
      - <span style="color:#a31515">&#34;8400:8400&#34;</span>
      - <span style="color:#a31515">&#34;8500:8500&#34;</span>
      - <span style="color:#a31515">&#34;8600:53/udp&#34;</span>
    volumes:
      - ./consul.d:/etc/consul.d
    command: agent -dev -client 0.0.0.0 -config-dir=/etc/consul.d</code></pre></div>
<h3 id="configuration">Configuration</h3>

<p>In <code>prometheus.yml</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">global:
  scrape_interval: 15s

scrape_configs:
  <span style="color:#008000"># Self-monitoring</span>
  - job_name: <span style="color:#a31515">&#39;prometheus&#39;</span>
    static_configs:
      - targets: [<span style="color:#a31515">&#39;localhost:9090&#39;</span>]
      - labels:
          instance: prometheus
  <span style="color:#008000"># Without service discovery</span>
  - job_name: <span style="color:#a31515">&#39;node_exporter&#39;</span>
    static_configs:
      - targets: [<span style="color:#a31515">&#39;$PRIVATE_IP_ADDRESS:9100&#39;</span>]
      - labels:
          instance: node_exporter
  <span style="color:#008000"># With service discovery, discard the job above</span>
  - job_name: <span style="color:#a31515">&#39;node_exporter&#39;</span>
    consul_sd_configs:
      - server: $PRIVATE_IP_ADDRESS:8500
        services:
          - node_exporter</code></pre></div>
<h2 id="grafana">Grafana</h2>

<p><a href="https://grafana.com/">Grafana</a> allows users to query, visualize, alert on and understand your metrics no matter where they are stored, supports multiple data sources and provides very powerful dashboard for displaying multiple metrics.</p>

<h3 id="installation-1">Installation</h3>

<p>In <code>docker-compose.yml</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">services:
  grafana:
    image: grafana/grafana
    restart: always
    ports:
      - 3000:3000
    volumes:
      - grafana:/var/lib/grafana
volumes:
  grafana:</code></pre></div>
<p>Grafana provides a UI at <code>:3000</code> by default.</p>

<p>You could follow the instructions in Grafana to add data sources including Prometheus and import dashboards.</p>

<p><a href="https://grafana.com/dashboards/159">This dashboard</a> could show system status according to the data collected by Prometheus.</p>

<h2 id="references">References</h2>

<ul>
<li><a href="https://prometheus.io/docs/introduction/overview/">https://prometheus.io/docs/introduction/overview/</a></li>
<li><a href="https://grafana.com/docs/">https://grafana.com/docs/</a></li>
<li><a href="https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/sd/service-discovery-with-consul">https://yunlzheng.gitbook.io/prometheus-book/part-ii-prometheus-jin-jie/sd/service-discovery-with-consul</a></li>
</ul>

		</div><div id="disqus_thread"></div>
<script type="text/javascript">
	(function () {
		
		
		if (window.location.hostname == "localhost")
			return;

		var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		var disqus_shortname = 'rudeigerc';
		dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
		Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div><a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="gohugo.io">Hugo</a></div>
	</nav>
</div>

</body>
</html>
